# GitHub Actions è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# æ„å»ºé•œåƒæ¨é€åˆ° GitHubï¼ŒåŒæ—¶ç›´æ¥ä¼ è¾“åˆ°æœåŠ¡å™¨éƒ¨ç½²

name: Build and Deploy

on:
  push:
    branches: [production]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ç”Ÿæˆæ—¶é—´æˆ³æ ‡ç­¾
      - name: Generate image tag
        id: tag
        run: echo "tag=$(TZ='Asia/Shanghai' date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½• GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ„å»ºå¹¶æ¨é€é•œåƒåˆ° ghcr.io
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      # é…ç½® SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–é•œåƒå¹¶éƒ¨ç½²
      - name: Deploy on server
        run: |
          ssh -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd /opt/judiciary-backend

            echo ""
            echo "========================================"
            echo "ğŸš€ å¸æ³•ç›‘ç®¡ç³»ç»Ÿ - åç«¯éƒ¨ç½²"
            echo "========================================"
            echo "ğŸ“… å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "ğŸ“‚ éƒ¨ç½²ç›®å½•: $(pwd)"
            echo ""

            # è®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡
            export http_proxy=http://127.0.0.1:7890
            export https_proxy=http://127.0.0.1:7890

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "----------------------------------------"
            echo "ğŸ“¦ æ­¥éª¤ 1/3: æ‹‰å–æœ€æ–°é•œåƒ..."
            echo "----------------------------------------"
            sudo -E docker compose pull
            echo "âœ… é•œåƒæ‹‰å–å®Œæˆ"
            echo ""

            # é‡å¯æœåŠ¡
            echo "----------------------------------------"
            echo "ğŸ”„ æ­¥éª¤ 2/3: é‡å¯æœåŠ¡..."
            echo "----------------------------------------"
            sudo docker compose up -d
            echo "âœ… æœåŠ¡é‡å¯å®Œæˆ"
            echo ""

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "----------------------------------------"
            echo "ğŸ” æ­¥éª¤ 3/3: æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            echo "----------------------------------------"
            sleep 3
            sudo docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
            echo ""

            # å¥åº·æ£€æŸ¥ï¼ˆç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨ï¼‰
            echo "----------------------------------------"
            echo "ğŸ’Š å¥åº·æ£€æŸ¥..."
            echo "----------------------------------------"
            echo "â³ ç­‰å¾…10ç§’è®©æœåŠ¡å®Œå…¨å¯åŠ¨..."
            sleep 10
            if sudo docker compose ps | grep -q "unhealthy\|Exit"; then
              echo "âš ï¸  è­¦å‘Š: å­˜åœ¨å¼‚å¸¸å®¹å™¨ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
              sudo docker compose logs --tail=20
              exit 1
            else
              echo "âœ… æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸"
            fi
            echo ""

            echo "========================================"
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
            echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "========================================"
          ENDSSH
