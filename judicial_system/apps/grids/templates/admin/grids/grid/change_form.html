{% extends "admin/change_form.html" %}
{% load i18n admin_modify %}

{% block object-tools %}
  {% if not is_popup %}
    <ul class="object-tools">
      <li>
        {% with ns=request.resolver_match.namespace|default:"admin" %}
          {% with viewname=ns|add:":grids_grid_draw_boundary" %}
            <a href="{% url viewname %}" class="historylink" target="_blank">
              {% trans "绘制边界坐标" %}
            </a>
          {% endwith %}
        {% endwith %}
      </li>
      {% if change %}
        {% change_form_object_tools %}
      {% endif %}
    </ul>
  {% endif %}
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script>
    (function () {
      var STORAGE_KEY = "judiciary.grids.grid.boundary_draft";
      var SESSION_LAST_ID_KEY = "judiciary.grids.grid.boundary_draft.last_id";
      var MAX_AGE_MS = 2 * 60 * 60 * 1000; // 2h

      function setValue(id, value) {
        var el = document.getElementById(id);
        if (!el && typeof id === "string" && id.indexOf("id_") === 0) {
          try {
            el = document.querySelector("[name='" + id.slice(3) + "']");
          } catch (e) {
            el = null;
          }
        }
        if (!el) return false;
        el.value = value;
        el.dispatchEvent(new Event("change", { bubbles: true }));
        el.dispatchEvent(new Event("input", { bubbles: true }));
        return true;
      }

      function applyBoundaryPayload(payload) {
        if (!payload) return false;
        var okBoundary = false;
        if (payload.boundary_json) {
          okBoundary = setValue("id_boundary", payload.boundary_json);
        }
        if (payload.center_lng != null) {
          setValue("id_center_lng", String(payload.center_lng));
        }
        if (payload.center_lat != null) {
          setValue("id_center_lat", String(payload.center_lat));
        }
        return okBoundary;
      }

      function applyFromStorageValue(raw) {
        if (!raw) return;
        var data = null;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          return;
        }
        if (!data || data.type !== "grids.grid.boundary") return;
        if (typeof data.ts === "number" && Date.now() - data.ts > MAX_AGE_MS) return;

        var id = data.id ? String(data.id) : "";
        try {
          if (id && window.sessionStorage && sessionStorage.getItem(SESSION_LAST_ID_KEY) === id) {
            return;
          }
        } catch (e) {}

        var ok = applyBoundaryPayload(data.payload || {});
        if (ok) {
          try {
            if (id && window.sessionStorage) {
              sessionStorage.setItem(SESSION_LAST_ID_KEY, id);
            }
          } catch (e) {}
          try {
            localStorage.removeItem(STORAGE_KEY);
          } catch (e) {}
        }
      }

      window.addEventListener("message", function (event) {
        if (!event || !event.data) return;
        if (event.origin && event.origin !== window.location.origin) return;
        var data = event.data;
        if (data && data.type === "grids.grid.boundary") {
          applyBoundaryPayload(data.payload || {});
        }
      });

      try {
        applyFromStorageValue(localStorage.getItem(STORAGE_KEY));
      } catch (e) {}

      window.addEventListener("storage", function (event) {
        if (!event) return;
        if (event.key === STORAGE_KEY) {
          applyFromStorageValue(event.newValue);
        }
      });
    })();
  </script>
{% endblock %}
