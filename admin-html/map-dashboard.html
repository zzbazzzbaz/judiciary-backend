<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>网格/任务地图可视化面板</title>

    <script src="./js/tailwind-config.js"></script>
    <script src="./vendor/tailwindcss.js"></script>

    <!-- 腾讯地图 SDK：必须同步加载以避免 document.write 问题 -->
    <script src="https://map.qq.com/api/js?v=2.exp&key=4H4BZ-OJACL-DKBPM-E7Y5H-5VSK5-KFFKK&libraries=drawing,geometry"></script>

    <style>
      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial,
          "Noto Sans",
          "Apple Color Emoji",
          "Segoe UI Emoji",
          "Segoe UI Symbol",
          "Noto Color Emoji";
      }

      /* 避免腾讯地图容器在某些环境下被压缩为 0 高度 */
      #map {
        min-height: 640px;
      }
    </style>
  </head>

  <body class="bg-slate-50 text-slate-900">
    <div class="min-h-screen flex flex-col">
      <main class="mx-auto w-full max-w-[1680px] flex-1 px-4 py-4">
        <div class="flex gap-4 items-stretch">
          <section class="flex-1 min-h-[720px] rounded-xl border border-slate-200 bg-white relative overflow-hidden shadow-sm">
            <div id="map" class="absolute inset-0"></div>


            <div class="absolute bottom-3 right-3 z-10 flex flex-wrap gap-2">
              <button
                id="btn-center"
                type="button"
                class="rounded-md border border-slate-300 bg-white/90 px-3 py-2 text-sm shadow-sm hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                回到中心
              </button>
            </div>
          </section>

          <aside class="w-[440px] max-w-[46vw] flex flex-col rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <!-- Tab 导航 -->
            <div class="flex border-b border-slate-200">
              <button type="button" data-tab="grids" class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50/50">网格围栏</button>
              <button type="button" data-tab="tasks" class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 hover:bg-slate-50">任务点</button>
              <button type="button" data-tab="create" class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 hover:bg-slate-50">创建网格</button>
            </div>

            <!-- Tab 面板：网格围栏 -->
            <div id="tab-grids" class="tab-panel flex-1 p-4 overflow-auto">
              <div class="flex items-center gap-2 mb-3">
                <button id="btn-toggle-grids" type="button" class="rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:opacity-50 disabled:cursor-not-allowed">隐藏围栏</button>
                <button id="btn-refresh-grids" type="button" class="rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:opacity-50 disabled:cursor-not-allowed">刷新</button>
              </div>
              <div class="flex items-center justify-between gap-3">
                <input id="grid-filter" type="search" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300" placeholder="搜索：网格名称/所属区域" />
                <span id="grid-count" class="shrink-0 text-xs text-slate-500">0</span>
              </div>
              <ul id="grid-list" class="mt-3 space-y-2 max-h-[calc(100vh-320px)] overflow-auto pr-1"></ul>
              <p id="grid-empty" class="mt-3 hidden text-xs text-slate-500">暂无可显示的网格。</p>
            </div>

            <!-- Tab 面板：任务点 -->
            <div id="tab-tasks" class="tab-panel flex-1 p-4 overflow-auto hidden">
              <div class="flex items-center gap-2 mb-3">
                <button id="btn-toggle-tasks" type="button" class="rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:opacity-50 disabled:cursor-not-allowed">隐藏任务点</button>
                <button id="btn-refresh-tasks" type="button" class="rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-200 disabled:opacity-50 disabled:cursor-not-allowed">刷新</button>
              </div>
              <div class="flex items-center justify-between gap-3">
                <input id="task-filter" type="search" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300" placeholder="搜索：任务编号/当事人/地址" />
                <span id="task-count" class="shrink-0 text-xs text-slate-500">0</span>
              </div>
              <div class="mt-3 flex flex-wrap gap-x-3 gap-y-1 text-[11px] text-slate-500">
                <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-amber-500"></span>已上报</span>
                <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span>已分配</span>
                <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-violet-500"></span>处理中</span>
                <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span>已完成</span>
              </div>
              <ul id="task-list" class="mt-3 space-y-2 max-h-[calc(100vh-380px)] overflow-auto pr-1"></ul>
              <p id="task-empty" class="mt-3 hidden text-xs text-slate-500">暂无任务点</p>
            </div>

            <!-- Tab 面板：创建网格 -->
            <div id="tab-create" class="tab-panel flex-1 p-4 overflow-auto hidden">
              <div class="grid gap-3">
                <input id="create-grid-name" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300" placeholder="网格名称，例如：朝阳网格" />
                <div class="flex flex-wrap gap-2">
                  <button id="btn-draw-start" type="button" class="rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:opacity-50 disabled:cursor-not-allowed">开始绘制</button>
                  <button id="btn-draw-clear" type="button" class="rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>清除</button>
                  <button id="btn-create-grid" type="button" class="rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>创建网格</button>
                </div>
                <label class="text-xs text-slate-600">
                  边界坐标（[[lng, lat], ...]）
                  <textarea id="create-grid-boundary" readonly class="mt-1 w-full min-h-[120px] resize-none rounded-md border border-slate-300 bg-slate-50 px-3 py-2 font-mono text-[11px] text-slate-900 shadow-sm focus:outline-none" placeholder="绘制完成后自动生成"></textarea>
                </label>
              </div>
            </div>
          </aside>
        </div>
      </main>
    </div>

    <script src="./api/api-client.js"></script>
    <script src="./js/map-dashboard.js"></script>
  </body>
</html>
